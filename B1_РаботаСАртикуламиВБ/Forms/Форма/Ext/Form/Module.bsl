
// Обработчик открытия формы на сервере
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	// Загружаем сохраненного клиента из настроек
	ЗагрузитьНастройки();
	// Загружаем данные при открытии
	ЗагрузитьДанныеНаСервере();
КонецПроцедуры

// Загрузка настроек (сохраненный клиент)
&НаСервере
Процедура ЗагрузитьНастройки()
	Настройки = ХранилищеОбщихНастроек.Загрузить("B1_РаботаСАртикуламиВБ", "Клиент");
	Если Настройки <> Неопределено Тогда
		Клиент = Настройки;
	КонецЕсли;
КонецПроцедуры

// Сохранение настроек (клиент)
&НаСервере
Процедура СохранитьНастройки()
	ХранилищеОбщихНастроек.Сохранить("B1_РаботаСАртикуламиВБ", "Клиент", Клиент);
КонецПроцедуры

// Загрузка данных из базы
&НаКлиенте
Процедура ЗагрузитьДанные(Команда = Неопределено)
	ЗагрузитьДанныеНаСервере();
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьДанныеНаСервере()
	
	ТаблицаАртикулов.Очистить();
	
	// Запрос для получения номенклатуры и характеристик
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
		|	Номенклатура.Артикул КАК Артикул,
		|	Номенклатура.B1_АртикулВБ КАК АртикулВБ,
		|	"""" КАК ДопАртикулДляВБ,
		|	ЛОЖЬ КАК Изменен
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	НЕ Номенклатура.ПометкаУдаления
		|	И НЕ Номенклатура.ЭтоГруппа
		|	И &УсловиеОтбораПоНоменклатуре
		|	И &УсловиеОтбораПоКлиенту
		|	И &УсловиеОтбораПоАртикулу
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ХарактеристикиНоменклатуры.Владелец,
		|	ХарактеристикиНоменклатуры.Ссылка,
		|	ХарактеристикиНоменклатуры.Владелец.Артикул,
		|	ХарактеристикиНоменклатуры.B1_АртикулВБ,
		|	ХарактеристикиНоменклатуры.B1_ДопАртикулДляВБ,
		|	ЛОЖЬ
		|ИЗ
		|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|ГДЕ
		|	НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
		|	И &УсловиеОтбораПоНоменклатуре2
		|	И &УсловиеОтбораПоКлиенту2
		|	И &УсловиеОтбораПоАртикулу2
		|
		|УПОРЯДОЧИТЬ ПО
		|	Номенклатура,
		|	Характеристика";
	
	// Формируем условия отбора по номенклатуре - СНАЧАЛА ДЛИННУЮ СТРОКУ!
	Если ЗначениеЗаполнено(ОтборПоНоменклатуре) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоНоменклатуре2", "ХарактеристикиНоменклатуры.Владелец = &ОтборПоНоменклатуре");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоНоменклатуре", "Номенклатура.Ссылка = &ОтборПоНоменклатуре");
		Запрос.УстановитьПараметр("ОтборПоНоменклатуре", ОтборПоНоменклатуре);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоНоменклатуре2", "ИСТИНА");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоНоменклатуре", "ИСТИНА");
	КонецЕсли;
	
	// Отбор по клиенту - только товары отгруженные клиенту ВБ
	Если ЗначениеЗаполнено(Клиент) Тогда
		ТекстУсловия = "Номенклатура.Ссылка В
		|		(ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			РеализацияТоваровУслуг.Номенклатура
		|		ИЗ
		|			Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслуг
		|		ГДЕ
		|			РеализацияТоваровУслуг.Ссылка.Контрагент = &Клиент
		|			И РеализацияТоваровУслуг.Ссылка.Проведен)";
		
		ТекстУсловия2 = "ХарактеристикиНоменклатуры.Владелец В
		|		(ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			РеализацияТоваровУслуг.Номенклатура
		|		ИЗ
		|			Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслуг
		|		ГДЕ
		|			РеализацияТоваровУслуг.Ссылка.Контрагент = &Клиент
		|			И РеализацияТоваровУслуг.Ссылка.Проведен)";
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоКлиенту2", ТекстУсловия2);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоКлиенту", ТекстУсловия);
		Запрос.УстановитьПараметр("Клиент", Клиент);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоКлиенту2", "ИСТИНА");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоКлиенту", "ИСТИНА");
	КонецЕсли;
	
	// Отбор по артикулу - СНАЧАЛА ДЛИННУЮ СТРОКУ!
	Если ТолькоБезАртикулов Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоАртикулу2", "ХарактеристикиНоменклатуры.B1_АртикулВБ = 0");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоАртикулу", "Номенклатура.B1_АртикулВБ = 0");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоАртикулу2", "ИСТИНА");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеОтбораПоАртикулу", "ИСТИНА");
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = ТаблицаАртикулов.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
	КонецЦикла;
	
	Сообщить("Загружено записей: " + ТаблицаАртикулов.Количество());
	
КонецПроцедуры

// Сохранение изменений в базу
&НаКлиенте
Процедура Сохранить(Команда)
	
	КоличествоИзмененных = 0;
	
	// Подсчитываем количество измененных строк
	Для Каждого Строка Из ТаблицаАртикулов Цикл
		Если Строка.Изменен Тогда
			КоличествоИзмененных = КоличествоИзмененных + 1;
		КонецЕсли;
	КонецЦикла;
	
	Если КоличествоИзмененных = 0 Тогда
		Сообщить("Нет измененных записей для сохранения");
		Возврат;
	КонецЕсли;
	
	// Асинхронный запрос подтверждения
	Оповещение = Новый ОписаниеОповещения("СохранитьЗавершение", ЭтотОбъект, КоличествоИзмененных);
	ПоказатьВопрос(Оповещение, "Сохранить изменения? Будет сохранено записей: " + КоличествоИзмененных, РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

// Callback после подтверждения сохранения
&НаКлиенте
Процедура СохранитьЗавершение(Результат, КоличествоИзмененных) Экспорт
	Если Результат = КодВозвратаДиалога.Да Тогда
		СохранитьНаСервере();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура СохранитьНаСервере()
	
	КоличествоСохраненных = 0;
	КоличествоОшибок = 0;
	
	НачатьТранзакцию();
	
	Попытка
		
		Для Каждого Строка Из ТаблицаАртикулов Цикл
			
			Если НЕ Строка.Изменен Тогда
				Продолжить;
			КонецЕсли;
			
			Попытка
				
				// Определяем что сохранять - номенклатуру или характеристику
				Если ЗначениеЗаполнено(Строка.Характеристика) Тогда
					// Сохраняем характеристику
					ХарактеристикаОбъект = Строка.Характеристика.ПолучитьОбъект();
					ХарактеристикаОбъект.B1_АртикулВБ = Строка.АртикулВБ;
					ХарактеристикаОбъект.B1_ДопАртикулДляВБ = Строка.ДопАртикулДляВБ;
					ХарактеристикаОбъект.Записать();
				Иначе
					// Сохраняем номенклатуру
					НоменклатураОбъект = Строка.Номенклатура.ПолучитьОбъект();
					НоменклатураОбъект.B1_АртикулВБ = Строка.АртикулВБ;
					НоменклатураОбъект.Записать();
				КонецЕсли;
				
				КоличествоСохраненных = КоличествоСохраненных + 1;
				Строка.Изменен = Ложь;
				
			Исключение
				КоличествоОшибок = КоличествоОшибок + 1;
				Сообщить("Ошибка сохранения: " + ОписаниеОшибки());
			КонецПопытки;
			
		КонецЦикла;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		Сообщить("Ошибка при сохранении: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	Сообщить("Сохранено записей: " + КоличествоСохраненных + 
	         ?(КоличествоОшибок > 0, ", ошибок: " + КоличествоОшибок, ""));
	
КонецПроцедуры

// Очистка артикулов у выделенных строк
&НаКлиенте
Процедура ОчиститьВыделенные(Команда)
	
	ВыделенныеСтроки = Элементы.ТаблицаАртикулов.ВыделенныеСтроки;
	
	Если ВыделенныеСтроки.Количество() = 0 Тогда
		Сообщить("Выберите строки для очистки");
		Возврат;
	КонецЕсли;
	
	// Асинхронный запрос подтверждения
	Оповещение = Новый ОписаниеОповещения("ОчиститьВыделенныеЗавершение", ЭтотОбъект, ВыделенныеСтроки);
	ПоказатьВопрос(Оповещение, "Очистить артикулы ВБ у выделенных строк (" + ВыделенныеСтроки.Количество() + ")?", РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

// Callback после подтверждения очистки
&НаКлиенте
Процедура ОчиститьВыделенныеЗавершение(Результат, ВыделенныеСтроки) Экспорт
	Если Результат = КодВозвратаДиалога.Да Тогда
		Для Каждого ИдентификаторСтроки Из ВыделенныеСтроки Цикл
			СтрокаТаблицы = ТаблицаАртикулов.НайтиПоИдентификатору(ИдентификаторСтроки);
			Если СтрокаТаблицы <> Неопределено Тогда
				СтрокаТаблицы.АртикулВБ = 0;
				СтрокаТаблицы.ДопАртикулДляВБ = "";
				СтрокаТаблицы.Изменен = Истина;
			КонецЕсли;
		КонецЦикла;
		Сообщить("Артикулы очищены. Не забудьте сохранить изменения!");
	КонецЕсли;
КонецПроцедуры

// Обработчики изменения фильтров
&НаКлиенте
Процедура КлиентПриИзменении(Элемент)
	СохранитьНастройки(); // Сохраняем выбранного клиента
	ЗагрузитьДанные();
КонецПроцедуры

&НаКлиенте
Процедура ОтборПоНоменклатуреПриИзменении(Элемент)
	ЗагрузитьДанные();
КонецПроцедуры

&НаКлиенте
Процедура ТолькоБезАртикуловПриИзменении(Элемент)
	ЗагрузитьДанные();
КонецПроцедуры

// Обработчики изменения артикулов в таблице
&НаКлиенте
Процедура ТаблицаАртикуловАртикулВБПриИзменении(Элемент)
	ТекущиеДанные = Элементы.ТаблицаАртикулов.ТекущиеДанные;
	Если ТекущиеДанные <> Неопределено Тогда
		ТекущиеДанные.Изменен = Истина;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаАртикуловДопАртикулДляВБПриИзменении(Элемент)
	ТекущиеДанные = Элементы.ТаблицаАртикулов.ТекущиеДанные;
	Если ТекущиеДанные <> Неопределено Тогда
		ТекущиеДанные.Изменен = Истина;
	КонецЕсли;
КонецПроцедуры
